version: 2.1
orbs:
  r-packages: displayr/r-packages@dev:eca93f28d0d3f05df4e5ba908c93ed358dba9cc3
parameters:
  trigger-message:
    type: string
    default: ""
  remote-deps:
    type: string
    default: ""
  plugins-branch:
    type: string
    default: ""
  triggered-packages:
    type: string
    default: ""
workflows:
  build-and-check-R-package:
    jobs:
      - r-packages/build-and-check-package:
          executor: nightly
          resource-class: large
          name: BuildAndCheckPackage
          context:
            - r_packages
          remote-deps: << pipeline.parameters.remote-deps >>
          separate-test-job: true
      - r-packages/test-package:
          executor: nightly
          resource-class: large
          name: TestPackage
          requires:
            - BuildAndCheckPackage
          context:
            - r_packages
      - r-packages/deploy-package:
          executor: rocker
          resource-class: small
          requires:
            - TestPackage
          context:
            - r_packages
          filters:
            branches:
              only:
                - master
      - r-packages/trigger-revdeps:
          executor: rocker
          resource-class: small
          requires:
            - TestPackage
          context:
            - r_packages
          remote-deps: << pipeline.parameters.remote-deps >>
          plugins-branch: << pipeline.parameters.plugins-branch >>
          trigger-message: << pipeline.parameters.trigger-message >>
          triggered-packages: << pipeline.parameters.triggered-packages >>
